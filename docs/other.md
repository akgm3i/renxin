# 補足仕様書（エラーハンドリング・設定・ログ）
## 1. はじめに

本ドキュメントは、アプリケーションの安定性と保守性を確保するため、正常系以外の動作（エラーハンドリング）、ユーザーによるカスタマイズ（設定管理）、そして問題発生時の原因究明（ログと診断）に関する仕様を定義するものである。

## 2. エラーハンドリングとエッジケース

予期せぬ事態が発生した際の、アプリケーションの具体的な振る舞いを定義する。

|コンポーネント|発生状況|UI/UX上の振る舞い|システムの内部動作|
|---|---|---|---|
|【ハードウェア関連】|カメラが認識されない（起動時）|**モーダルダイアログ（高優先度、永続）**: 「カメラが見つかりません。設定を確認してください」と表示。OKを押すと設定画面に遷移し、ユーザーがカメラ設定を修正できるよう促す。|Coreプロセスはカメラデバイスのスキャンに失敗。UIプロセスにエラーコードを返し、UIは対応するダイアログを表示。アプリケーションの起動をブロックし、設定修正を必須とする。|
|【ハードウェア関連】|カメラが切断された（録画中）|**トースト通知（中優先度、短時間表示）**: 画面隅に「カメラ接続が切れました。録画は停止されました。」というメッセージを短時間表示。ゲームの進行は妨げない。|録画処理は即座に停止。エラーをログに記録する。ゲームの進行は継続可能だが、動画記録は行われない。|
|【ハードウェア関連】|ディスク空き容量不足（録画中）|**モーダルダイアログ（高優先度、永続）**: 「ディスクの空き容量が不足しているため、録画を停止しました。不要なファイルを削除してください。」と表示。OKを押すとダイアログが閉じ、ユーザーが手動でディスク容量を確保できるよう促す。|ファイル書き込み時にOSからエラーを受け取る。以降の録画処理をすべてスキップし、エラーをログに記録する。ゲームの進行は継続可能。|
|【データ関連】|データベースファイルが破損|**モーダルダイアログ（最高優先度、永続）**: 「データを正常に読み込めませんでした。バックアップから復元しますか？」という確認ダイアログを表示。「はい」で復元処理、「いいえ」でアプリを終了。復元失敗時はアプリを終了する。|起動時にDBファイルの整合性チェックを行う。エラーを検知した場合、UIに通知。ユーザーの選択に応じてバックアップ処理または終了処理を実行。アプリケーションの起動をブロックする。|
|【ネットワーク関連 (RPC)】|RPC用のポートが使用済み|**モーダルダイアログ（高優先度、永続）**: 「通信ポート(8080)が他のアプリで使用されています。設定から変更してください。」と表示。OKを押すと設定画面に遷移し、ユーザーがポート番号を修正できるよう促す。|CoreプロセスがRPCサーバーの起動に失敗。UIにエラーを通知し、対応するダイアログを表示。RPCサーバー機能は利用不可となる。|
|【ネットワーク関連 (RPC)】|閲覧ブラウザの接続が切断|(閲覧ブラウザ側) **オーバーレイ表示（中優先度、永続）**: 画面に「サーバーとの接続が切れました。再接続中...」というオーバーレイを表示。再接続成功時に自動で消える。|(閲覧ブラウザ側) WebSocketの切断を検知し、指数バックオフアルゴリズムを用いて自動で再接続を試みる。再接続に失敗し続けた場合は、再接続を諦め、エラーメッセージを表示する。|

## 3. 設定管理

ユーザーがカスタマイズ可能な項目と、その管理方法を定義する。

- 設定ファイルの形式と場所:
    - 形式: TOML形式。人間が読み書きしやすいため。
    - 場所: アプリケーションのデータディレクトリ内に config.toml として保存する。
- 設定項目:
|カテゴリ|設定キー|データ型|説明|デフォルト値|
|---|---|---|---|---|
|カメラ設定|posture_camera_id|String|姿勢用として使用するカメラのデバイスID|"" (自動選択)|
|カメラ設定|board_camera_id|String|ボード用として使用するカメラのデバイスID|"" (自動選択)|
|カメラ設定|video_resolution|String|動画の解像度|"1280x720"|
|カメラ設定|video_framerate|Integer|動画のフレームレート|30|
|データ管理|database_path|String|データベースファイルの保存場所|(アプリデータ)/data.db|
|データ管理|video_storage_path|String|動画ファイルの保存場所|(アプリデータ)/videos/|
|データ管理|auto_delete_days|Integer|指定した日数より古い動画を自動削除する。0で無効。|90|
|ネットワーク設定|rpc_port|Integer|リアルタイム通信に使用するポート番号|8080|

## 4. ログと診断

問題発生時の原因究明を容易にするための仕様を定義する。

- ログレベル:
    - ERROR: アプリケーションの動作に支障をきたす致命的な問題。
    - WARN: 予期せぬ事態だが、動作は継続可能な問題。
    - INFO: 通常の動作記録（ゲーム開始・終了など）。
    - DEBUG: 開発者向けの詳細な動作記録。
- ログの出力と管理:
    - 出力先: アプリケーションのデータディレクトリ内に renxin.log として出力する。
        - Linux: `$XDG_DATA_HOME/{bundleIdentifier}/logs` or `$HOME/.local/share/{bundleIdentifier}/logs`
        - macOS/iOS: `{homeDir}/Library/Logs/{bundleIdentifier}`
        - Windows: `{FOLDERID_LocalAppData}/{bundleIdentifier}/logs`
    - ローテーション: ファイルサイズが4MBを超えると、古いログは `renxin_YYYY-MM-DD_HH-mm-ss.log` にリネームされ、新しいログファイルが作成される。
- ログのフォーマット:
    - YYYY-MM-DD_H-mm-ss[Target][Level] メッセージ の形式で記録する。
    - 例: 2025-08-05_18-30-05[Camera][ERROR] Failed to connect to camera device (ID: ...)
- ログのエクスポート機能:
    - 設定画面に「診断情報をエクスポート」ボタンを設置する。
    - ボタンを押すと、ログファイル (renxin.log) と設定ファイル (config.toml) をまとめたZIPファイル (darts_diag_YYYYMMDD.zip) を作成し、指定された保存場所に保存する。
- ログの機密情報マスキング:
    - ログ出力時には、個人を特定できる情報（例: ユーザー名を含むファイルパス、IPアドレス）や機密情報が直接記録されないよう、マスキングまたは匿名化を行う。
    - 例: `/home/user/videos/` -> `/home/[MASKED]/videos/`
