# ダーツ練習支援アプリケーション 仕様書
## 1. 概要

本ドキュメントは、ダーツの練習を支援・記録・分析するためのアプリケーション開発に関する仕様を定義するものである。タッチパネル操作による直感的なUI、カメラによるフォームおよび弾道の撮影・分析、スコアとスタッツの記録・可視化を通じて、プレイヤーの技術向上をサポートすることを目的とする。

## 2. プロジェクトの目的

練習の質の向上: 自身のフォームやダーツの弾道を客観的に確認することで、課題の発見と改善を促す。

モチベーションの維持: スコアやレーティング、各種統計データを記録・可視化し、成長を実感できるようにする。

練習データの集約: 複数の練習データを一元管理し、長期的な傾向分析を可能にする。

リモート共有: 練習の様子や成果を、遠隔地にいる仲間やコーチとリアルタイムで共有できる環境を提供する。

## 3. 用語定義
| 用語 | 説明 |
|---|---|
| 01ゲーム | 301, 501などの持ち点を減らしていき、ちょうど0にしたプレイヤーが勝利するゲーム形式。 |
| Cricket | 特定のナンバー（通常15〜20とBULL）を先に3マークした上で、相手より高得点を獲得することを目指すゲーム形式。 |
| スタッツ | Stats (Statistics) の略。PPDやMPRなど、プレイヤーの実力を示す統計値。 |
| PPD | Points Per Dart。01ゲームにおける、ダーツ1投あたりの平均得点。 |
| MPR | Marks Per Round。Cricketゲームにおける、1ラウンド（3投）あたりの平均マーク数。 |
| レーティング | プレイヤーの実力をクラス分けするための指標。スタッツを基に算出される。 |
| クライアント | ユーザーが直接操作するアプリケーション。 |
| サーバー | データ処理、保存、リアルタイム配信などを行うバックエンドシステム。 |
| IPC | Inter-Process Communicationの略。同一コンピュータ上の異なるプロセス間でデータを交換する仕組み。本システムではUIプロセスとCoreプロセス間の通信に利用。 |
| RPC | Remote Procedure Callの略。ネットワーク上の別のコンピュータにあるプログラムのプロシージャ（関数）を、あたかもローカルにあるかのように呼び出す仕組み。本システムでは閲覧用ブラウザとCoreプロセス間の通信に利用。 |
| Tauri | RustとWeb技術（HTML, CSS, JavaScript）を用いて、軽量で高速なクロスプラットフォームデスクトップアプリケーションを構築するためのフレームワーク。 |
| rusqlite | Rust言語でSQLiteデータベースを操作するためのライブラリ。本システムの埋め込みデータベースとして利用。 |

## 4. システム構成
### 4.1. ハードウェア構成
| 役割 | 機材名 | スペック概要 | 目的・用途 |
|---|---|---|---|
| クライアントPC | タッチパネル付きPC | CPU: Intel Core i5-4200U, メモリ: (要確認、8GB以上推奨), ストレージ: 128GB SSD, OS: Windows 10 Pro | アプリケーションの実行、UI表示、タッチ操作、カメラ制御 |
| 姿勢撮影カメラ | PC内蔵カメラ | 解像度・フレームレート: 不明 (要事前検証) | プレイヤーの全身または上半身を撮影し、フォームを確認する |
| ボード撮影カメラ | Logicool C920t | 解像度: フルHD 1080p, フレームレート: 30fps | ダーツボード全体を撮影し、ダーツの弾道と着弾位置を確認する |

## 4.2. ソフトウェア構成

本システムは、初期フェーズではクライアントPC内で完結する「ローカルファースト」アーキテクチャを採用する。これにより、オフライン環境での利用やシンプルなデプロイを実現する。将来的な機能拡張や他プラットフォームへの展開を見据え、クライアントとサーバーの役割を論理的に分離した設計とする。

### 4.2.1. 初期フェーズ (ローカルファースト)

クライアントアプリケーション (Windows / Ubuntu)

役割: UI/UXの提供、タッチ入力処理、カメラデバイスの制御、動画の録画・再生、データ永続化、リアルタイム通信サーバー機能（LAN内）。全ての役割を担うスタンドアロンアプリケーションとして動作する。

技術候補:

Tauri (Rust + TypeScript): Rustによる高速なバックエンドとWebベースのUIを組み合わせる。パフォーマンスとセキュリティに優れる。埋め込みデータベース（例: rusqliteを使用したSQLite）をCoreプロセスに組み込み、全てのデータをローカルに永続化する。

### 4.2.2. 将来的なサーバー分離フェーズ

将来的に、データの一元管理、高度な分析、複数デバイスからのアクセス、ユーザー認証などの要件が発生した場合、サーバーを分離する構成への移行を検討する。

クライアントアプリケーション (Windows / Ubuntu)

役割: UI/UXの提供、タッチ入力処理、カメラデバイスの制御、動画の録画・再生、サーバーとの通信。ローカルキャッシュを持ち、オフライン時も基本的な機能を提供できる「オフラインファースト」の設計を検討する。

技術候補:

Tauri (Rust + TypeScript): 引き続きTauriをクライアントとして利用。

サーバーアプリケーション

役割: ユーザー認証、スコア・統計データの永続化、レーティング計算、他PCへのリアルタイムデータ配信（WebSocket）、データ同期。

技術候補:

Rust: 高いパフォーマンスと安全性を両立。CPU負荷の高い処理（将来的な画像解析など）にも対応可能。

データベース

役割: スコア、ユーザー情報、統計データなどを保存する。

技術候補: PostgreSQL または MySQL。堅牢でスケーラブルなリレーショナルデータベース。

#### 認証・認可に関する考慮事項

将来的なサーバー分離フェーズでは、ユーザー認証と認可の仕組みが必要となる。OAuth2やJWTなどの標準的なプロトコルを採用し、セキュアなアクセス制御を実装する。

### 4.3. ネットワーク構成

クライアントとサーバー間は、通常のデータ取得にはHTTP/REST APIを、スコアや動画のリアルタイム共有にはWebSocketを使用する。

これにより、他PCのWebブラウザなどからも、低遅延で練習状況を確認できる。

## 5. 機能要件

### 5.1. ユーザーインターフェース (UI)

F-1.1: タッチパネルでの操作に最適化された、大きく直感的なボタンとレイアウトを採用する。

F-1.2: ダーツボードを模したUIを表示し、タッチすることで着弾点を入力できる。

F-1.3: 入力された着弾点に応じて、スコアが自動計算され表示される。

F-1.4: ゲーム（01/Cricket）の選択画面、設定画面、統計情報表示画面などを設ける。

F-1.5: UI/UXに関する詳細な定義は、別紙**「UI/UX仕様詳細」**を参照のこと。

### 5.2. スコア記録機能

F-2.1: 01ゲームおよびCricketゲームのスコアを記録できる。

F-2.2: プレイヤーは複数登録でき、プレイヤーごとにデータを管理できる。

F-2.3: ゲーム終了後、PPD/MPRなどのスタッツを自動で計算し表示する。

F-2.4: DartsLiveのレーティングテーブルに基づき、スタッツから総合レーティングを算出する。

参考: 総合レーティングは01のPPDとCricketのMPRの組み合わせで決定される。

F-2.5: 総合レーティングに加え、01ゲームとCricketゲームそれぞれのスタッツに基づいた独立したレーティングも算出し、表示・保存する。

F-2.6: データ永続化と通信に関する詳細な定義は、別紙**「データ・API仕様詳細」**を参照のこと。

### 5.3. カメラ連携機能

F-3.1: 練習開始時に、姿勢カメラとボードカメラの映像をリアルタイムで録画する。

F-3.2: 1ラウンド（3投）終了後、直前の投擲シーン（姿勢・弾道の両方）を即座に再生できる画面に遷移する。

F-3.3: 再生画面では、通常再生、スロー再生（0.5倍速など）、一時停止のコントロールが可能。

F-3.4: （将来的機能）ボードカメラの映像を解析し、ダーツの着弾位置を自動で検知・入力する。

開発難易度が高いため、初期リリースでは手動入力を必須とし、自動検知は補助的な機能または将来的な目標として位置づける。

### 5.4. データ分析・統計機能

F-4.1: 過去のゲーム履歴を一覧で確認できる。

F-4.2: 総合、01、Cricketそれぞれのレーティング、およびPPD/MPRの推移を折れ線グラフで表示する。

F-4.3: Cricketにおいて、各ナンバーのヒット率やマーク数を可視化する（ヒートマップなど）。

F-4.4: 日付やゲーム種別でデータをフィルタリングする機能を提供する。

F-4.5: レーティングは、総合的なものに加え、「そのゲーム単体」「当日」「直近10ゲーム」など、期間を区切ったものを切り替えて表示できる。

### 5.5. ネットワーク機能

F-5.1: サーバーに保存されたスコアや統計データに、他PCのWebブラウザからアクセスして閲覧できる。

F-5.2: 練習中のスコア状況や、再生中の動画を、他PCにリアルタイムでストリーミング配信できる。

## 6. 非機能要件
### 6.1. パフォーマンス

NF-1.1: UI操作は遅延なく、スムーズに反応すること。

NF-1.2: 3投終了後、5秒以内に動画再生画面に遷移できること。

NF-1.3: 2つのカメラ（PC内蔵カメラ + 1080p/30fps）で同時に録画しても、アプリケーションの動作が不安定にならないこと。

### 6.2. 拡張性・保守性

NF-2.1: 新しいゲーム形式や統計指標を容易に追加できる設計とすること。

NF-2.2: クライアントとサーバーの役割を分離し、それぞれ独立して開発・更新できるようにすること。

### 6.3. 移植性
NF-3.1: クライアントアプリケーションは、Windows 10およびUbuntuの最新LTS版で動作すること。

NF-3.2: OS固有の機能への依存を最小限に抑え、クロスプラットフォームな技術フレームワーク（Electron, Tauriなど）を利用すること。

## 7. 開発言語・技術選定

### クライアント

- tauri
    - FrontEnd
        - deno
        - TypeScript
        - React
    - Rust
        - SQLite

## 8. 課題・検討事項

ダーツの自動検知技術の確立:

課題: 照明環境、ダーツの色、カメラの角度など、外的要因による影響を受けやすく、安定した精度を出すためのアルゴリズム開発が最大の技術的挑戦となる。

対策: OpenCV等の画像処理ライブラリを用い、背景差分、色検出、輪郭検出などを組み合わせたプロトタイピングから着手する。初期は精度が出やすい特定条件下での利用を想定し、段階的に改善を図る。

ハードウェアスペックの制約:

課題: クライアントPCのCPUがCore i5に向上したことでパフォーマンスは改善されたが、2つの動画の同時録画・処理は依然として高負荷。特に、内蔵カメラの性能（解像度、フレームレート、ドライバの安定性）が不明なため、アプリケーションのパフォーマンスに影響を与える可能性がある。

対策: 録画処理の最適化（ハードウェアエンコーディングの利用）は引き続き重要。開発初期段階で、内蔵カメラを使用した動画録画の負荷テストを行い、安定して利用できる解像度とフレームレートを特定する必要がある。

## 9. テスト戦略

実装時に t_wada氏が推奨するTDD（テスト駆動開発）に従いテストを行う。
